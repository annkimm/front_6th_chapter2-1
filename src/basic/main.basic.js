import {
  PRODUCT_IDS,
  DISCOUNT_RATES,
  THRESHOLDS,
  TIMERS,
  POINTS,
} from './constants/index.js'
import {
  initializeState,
  getProducts,
  getProduct,
  getCartItems,
  getLastSelectedProductId,
  updateProduct,
  setLastSelectedProductId,
  getTotalAmount,
  getTotalQuantity,
  setBonusPoints,
  getCartQuantity,
  setCartQuantity,
} from './store/state.js'
import { createElement } from './utils/dom.js'
import {
  formatItemCount,
  formatPrice,
  formatDiscountRate,
  formatProductPrice,
  formatProductName,
} from './utils/formatters.js'
import { Header } from './components/Header.js'
import { CartItem } from './components/CartItem.js'
import { ProductContainer } from './components/ProductContainer.js'
import { OrderSummary } from './components/OrderSummary.js'
import { HelpModal } from './components/HelpModal.js'

var sel
var addBtn
var stockInfo
var cartDisp

function main() {
  initializeState()

  var root = document.getElementById('app')

  // Ïª¥Ìè¨ÎÑåÌä∏ ÏÇ¨Ïö©
  const header = Header()
  const gridContainer = createElement(
    'div',
    'grid grid-cols-1 lg:grid-cols-[1fr_360px] gap-6 flex-1 overflow-hidden',
  )

  const leftColumn = createElement(
    'div',
    'bg-white border border-gray-200 p-8 overflow-y-auto',
  )
  const productContainer = ProductContainer()
  leftColumn.appendChild(productContainer)

  cartDisp = createElement('div')
  cartDisp.id = 'cart-items'
  leftColumn.appendChild(cartDisp)

  const rightColumn = OrderSummary()
  const { toggleButton, overlay } = HelpModal()

  // DOM Ï°∞Î¶Ω
  gridContainer.appendChild(leftColumn)
  gridContainer.appendChild(rightColumn)

  root.appendChild(header)
  root.appendChild(gridContainer)
  root.appendChild(toggleButton)
  root.appendChild(overlay)

  // DOM ÏöîÏÜå Ï∞∏Ï°∞
  sel = document.getElementById('product-select')
  addBtn = document.getElementById('add-to-cart')
  stockInfo = document.getElementById('stock-status')

  // Ï¥àÍ∏∞Ìôî
  updateProductOptions()
  updateCart()
  setupEventHandlers()
  setupTimers()
}

// Ïû•Î∞îÍµ¨Îãà ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò (Ìï†Ïù∏ Í≥ÑÏÇ∞ Î°úÏßÅ Ìè¨Ìï®)
function updateCart() {
  const cartItems = getCartItems()

  var subTot = 0
  var itemDiscounts = []
  var totalQuantity = 0
  var totalAmount = 0

  // Í∞Å ÏïÑÏù¥ÌÖú Í≥ÑÏÇ∞
  Object.entries(cartItems).forEach(([productId, quantity]) => {
    const product = getProduct(productId)
    if (!product) return

    totalQuantity += quantity
    const itemTotal = product.price * quantity
    subTot += itemTotal

    var disc = 0
    if (quantity >= THRESHOLDS.MIN_QUANTITY_FOR_DISCOUNT) {
      const discountMap = {
        [PRODUCT_IDS.KEYBOARD]: DISCOUNT_RATES.KEYBOARD,
        [PRODUCT_IDS.MOUSE]: DISCOUNT_RATES.MOUSE,
        [PRODUCT_IDS.MONITOR_ARM]: DISCOUNT_RATES.MONITOR_ARM,
        [PRODUCT_IDS.LAPTOP_POUCH]: DISCOUNT_RATES.LAPTOP_POUCH,
        [PRODUCT_IDS.SPEAKER]: DISCOUNT_RATES.SPEAKER,
      }

      disc = discountMap[productId] || 0
      if (disc > 0) {
        itemDiscounts.push({ name: product.name, discount: disc * 100 })
      }
    }

    totalAmount += itemTotal * (1 - disc)

    // DOM Ïä§ÌÉÄÏùºÎßÅ
    const cartItem = document.getElementById(productId)
    if (cartItem) {
      const priceElement = cartItem.querySelector('.text-lg')
      if (priceElement) {
        priceElement.style.fontWeight =
          quantity >= THRESHOLDS.MIN_QUANTITY_FOR_DISCOUNT ? 'bold' : 'normal'
      }
    }
  })

  const originalTotal = subTot

  // ÎåÄÎüâ Íµ¨Îß§ Ìï†Ïù∏
  if (totalQuantity >= THRESHOLDS.MIN_QUANTITY_FOR_BULK) {
    totalAmount = subTot * (1 - DISCOUNT_RATES.BULK)
  }

  // ÌôîÏöîÏùº Ìï†Ïù∏
  const isTuesday = new Date().getDay() === 2
  const tuesdaySpecial = document.getElementById('tuesday-special')

  if (isTuesday && totalAmount > 0) {
    totalAmount = totalAmount * (1 - DISCOUNT_RATES.TUESDAY)
    tuesdaySpecial.classList.remove('hidden')
  } else {
    tuesdaySpecial.classList.add('hidden')
  }

  const discountRate =
    originalTotal > 0 ? (originalTotal - totalAmount) / originalTotal : 0

  // UI ÏóÖÎç∞Ïù¥Ìä∏
  document.getElementById('item-count').textContent =
    formatItemCount(totalQuantity)
  updateSummaryDetails(subTot, itemDiscounts, isTuesday, totalQuantity)
  updateTotal(totalAmount)
  updateDiscountInfo(discountRate, originalTotal, totalAmount)

  doRenderBonusPoints() // Í∏∞Ï°¥ Ìï®Ïàò ÏÇ¨Ïö© (ÏÑúÎπÑÏä§ ÎåÄÏã†)
  updateStockStatus()
}

function setupEventHandlers() {
  // Ïû•Î∞îÍµ¨Îãà Ï∂îÍ∞Ä Î≤ÑÌäº
  addBtn.addEventListener('click', function () {
    const selItem = sel.value
    const product = getProduct(selItem)

    if (!product || product.stock === 0) return

    var existingItem = document.getElementById(product.id)

    if (existingItem) {
      // Í∏∞Ï°¥ ÏïÑÏù¥ÌÖú ÏàòÎüâ Ï¶ùÍ∞Ä
      var qtyElem = existingItem.querySelector('.quantity-number')
      var newQty = parseInt(qtyElem.textContent) + 1

      if (product.stock > 0) {
        qtyElem.textContent = newQty
        const currentQuantity = getCartQuantity(selItem)
        setCartQuantity(selItem, currentQuantity + 1)
        updateProduct(selItem, { stock: product.stock - 1 })
      } else {
        alert('Ïû¨Í≥†Í∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.')
        return
      }
    } else {
      // CartItem Ïª¥Ìè¨ÎÑåÌä∏ ÏÇ¨Ïö©Ìï¥ÏÑú ÏÉà ÏïÑÏù¥ÌÖú ÏÉùÏÑ±
      const cartItemElement = CartItem(product)
      cartDisp.appendChild(cartItemElement)
      setCartQuantity(selItem, 1)
      updateProduct(selItem, { stock: product.stock - 1 })
    }

    setLastSelectedProductId(selItem)
    updateCart()
    updateProductOptions()
  })

  // Ïû•Î∞îÍµ¨Îãà ÏïÑÏù¥ÌÖú Ïù¥Î≤§Ìä∏
  cartDisp.addEventListener('click', function (event) {
    const tgt = event.target

    if (tgt.classList.contains('quantity-change')) {
      const prodId = tgt.dataset.productId
      const qtyChange = parseInt(tgt.dataset.change)

      // ÏßÅÏ†ë ÏàòÎüâ Î≥ÄÍ≤Ω Ï≤òÎ¶¨ (ÏÑúÎπÑÏä§ ÎåÄÏã†)
      const product = getProduct(prodId)
      const itemElem = document.getElementById(prodId)
      const qtyElem = itemElem.querySelector('.quantity-number')
      const currentQty = parseInt(qtyElem.textContent)
      const newQty = currentQty + qtyChange

      if (newQty > 0 && newQty <= product.stock + currentQty) {
        qtyElem.textContent = newQty
        setCartQuantity(prodId, newQty)
        updateProduct(prodId, { stock: product.stock - qtyChange })
      } else if (newQty <= 0) {
        // ÏàòÎüâÏù¥ 0Ïù¥ ÎêòÎ©¥ Ï†úÍ±∞
        setCartQuantity(prodId, 0)
        updateProduct(prodId, { stock: product.stock + currentQty })
        itemElem.remove()
      } else {
        alert('Ïû¨Í≥†Í∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.')
      }

      updateCart()
      updateProductOptions()
    } else if (tgt.classList.contains('remove-item')) {
      const prodId = tgt.dataset.productId

      // ÏßÅÏ†ë Ï†úÍ±∞ Ï≤òÎ¶¨ (ÏÑúÎπÑÏä§ ÎåÄÏã†)
      const product = getProduct(prodId)
      const itemElem = document.getElementById(prodId)
      const quantity = getCartQuantity(prodId)

      updateProduct(prodId, { stock: product.stock + quantity })
      setCartQuantity(prodId, 0)
      itemElem.remove()

      updateCart()
      updateProductOptions()
    }
  })
}

function setupTimers() {
  // Î≤àÍ∞úÏÑ∏Ïùº ÌÉÄÏù¥Î®∏
  const lightningDelay = Math.random() * TIMERS.LIGHTNING_SALE_MAX_DELAY
  setTimeout(() => {
    setInterval(function () {
      const products = getProducts()
      const availableProducts = products.filter((p) => p.stock > 0 && !p.onSale)

      if (availableProducts.length === 0) return

      const luckyIdx = Math.floor(Math.random() * availableProducts.length)
      const luckyItem = availableProducts[luckyIdx]

      updateProduct(luckyItem.id, {
        price: Math.round(
          luckyItem.originalPrice * (1 - DISCOUNT_RATES.LIGHTNING),
        ),
        onSale: true,
      })

      alert('‚ö°Î≤àÍ∞úÏÑ∏Ïùº! ' + luckyItem.name + 'Ïù¥(Í∞Ä) 20% Ìï†Ïù∏ Ï§ëÏûÖÎãàÎã§!')
      updateProductOptions()
      updateCartPrices()
    }, TIMERS.LIGHTNING_SALE_INTERVAL)
  }, lightningDelay)

  // Ï∂îÏ≤úÏÑ∏Ïùº ÌÉÄÏù¥Î®∏
  setTimeout(function () {
    setInterval(function () {
      const cartItems = getCartItems()
      const lastSelectedId = getLastSelectedProductId()

      if (Object.keys(cartItems).length === 0 || !lastSelectedId) return

      const products = getProducts()
      const recommendableProducts = products.filter(
        (p) => p.id !== lastSelectedId && p.stock > 0 && !p.recommendSale,
      )

      if (recommendableProducts.length === 0) return

      const suggest = recommendableProducts[0]
      alert(
        'üíù ' + suggest.name + 'ÏùÄ(Îäî) Ïñ¥Îñ†ÏÑ∏Ïöî? ÏßÄÍ∏à Íµ¨Îß§ÌïòÏãúÎ©¥ 5% Ï∂îÍ∞Ä Ìï†Ïù∏!',
      )

      updateProduct(suggest.id, {
        price: Math.round(suggest.price * (1 - DISCOUNT_RATES.RECOMMEND)),
        recommendSale: true,
      })

      updateProductOptions()
      updateCartPrices()
    }, TIMERS.RECOMMEND_SALE_INTERVAL)
  }, Math.random() * TIMERS.RECOMMEND_SALE_MAX_DELAY)
}

// Í∏∞Ï°¥ Ìï®ÏàòÎì§ (ÏïÑÏßÅ ÏÑúÎπÑÏä§Î°ú Ïù¥ÎèôÌïòÏßÄ ÏïäÏùå)
function updateProductOptions() {
  const products = getProducts()

  // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Í∞í Ï†ÄÏû•
  const currentValue = sel.value

  sel.innerHTML = ''
  var totalStock = products.reduce((sum, product) => sum + product.stock, 0)

  if (totalStock < THRESHOLDS.TOTAL_STOCK_WARNING) {
    sel.style.borderColor = 'orange'
  } else {
    sel.style.borderColor = ''
  }

  products.forEach((product) => {
    var opt = createElement('option')
    opt.value = product.id

    if (product.stock === 0) {
      opt.textContent = `${product.name} - ${formatPrice(product.price)} (ÌíàÏ†à)`
      opt.disabled = true
      opt.className = 'text-gray-400'
    } else {
      if (product.onSale && product.recommendSale) {
        opt.textContent = `‚ö°üíù${product.name} - ${formatPrice(product.originalPrice)} ‚Üí ${formatPrice(product.price)} (25% SUPER SALE!)`
        opt.className = 'text-purple-600 font-bold'
      } else if (product.onSale) {
        opt.textContent = `‚ö°${product.name} - ${formatPrice(product.originalPrice)} ‚Üí ${formatPrice(product.price)} (20% SALE!)`
        opt.className = 'text-red-500 font-bold'
      } else if (product.recommendSale) {
        opt.textContent = `üíù${product.name} - ${formatPrice(product.originalPrice)} ‚Üí ${formatPrice(product.price)} (5% Ï∂îÏ≤úÌï†Ïù∏!)`
        opt.className = 'text-blue-500 font-bold'
      } else {
        opt.textContent = `${product.name} - ${formatPrice(product.price)}`
      }
    }

    sel.appendChild(opt)
  })

  // Ïù¥Ï†ÑÏóê ÏÑ†ÌÉùÎêú Í∞í Î≥µÏõê
  if (currentValue) {
    sel.value = currentValue
  }

  updateStockStatus()
}

function updateStockStatus() {
  const products = getProducts()
  var stockMsg = ''

  products.forEach(function (item) {
    if (item.stock < THRESHOLDS.LOW_STOCK) {
      if (item.stock > 0) {
        stockMsg += `${item.name}: Ïû¨Í≥† Î∂ÄÏ°± (${item.stock}Í∞ú ÎÇ®Ïùå)\n`
      } else {
        stockMsg += `${item.name}: ÌíàÏ†à\n`
      }
    }
  })

  stockInfo.textContent = stockMsg
}

// UI ÏóÖÎç∞Ïù¥Ìä∏ Ìï®ÏàòÎì§
function updateSummaryDetails(
  subtotal,
  itemDiscounts,
  isTuesday,
  totalQuantity,
) {
  const summaryDetails = document.getElementById('summary-details')
  const cartItems = getCartItems()

  summaryDetails.innerHTML = ''

  if (subtotal === 0) return

  Object.entries(cartItems).forEach(([productId, quantity]) => {
    const product = getProduct(productId)
    if (!product) return

    const itemTotal = product.price * quantity
    summaryDetails.innerHTML += `
      <div class="flex justify-between text-xs tracking-wide text-gray-400">
        <span>${product.name} x ${quantity}</span>
        <span>${formatPrice(itemTotal)}</span>
      </div>
    `
  })

  summaryDetails.innerHTML += `
    <div class="border-t border-white/10 my-3"></div>
    <div class="flex justify-between text-sm tracking-wide">
      <span>Subtotal</span>
      <span>${formatPrice(subtotal)}</span>
    </div>
  `

  if (totalQuantity >= THRESHOLDS.MIN_QUANTITY_FOR_BULK) {
    summaryDetails.innerHTML += `
      <div class="flex justify-between text-sm tracking-wide text-green-400">
        <span class="text-xs">üéâ ÎåÄÎüâÍµ¨Îß§ Ìï†Ïù∏ (30Í∞ú Ïù¥ÏÉÅ)</span>
        <span class="text-xs">-25%</span>
      </div>
    `
  } else if (itemDiscounts.length > 0) {
    itemDiscounts.forEach((item) => {
      summaryDetails.innerHTML += `
        <div class="flex justify-between text-sm tracking-wide text-green-400">
          <span class="text-xs">${item.name} (10Í∞ú‚Üë)</span>
          <span class="text-xs">-${item.discount}%</span>
        </div>
      `
    })
  }

  if (isTuesday && totalQuantity > 0) {
    summaryDetails.innerHTML += `
      <div class="flex justify-between text-sm tracking-wide text-purple-400">
        <span class="text-xs">üåü ÌôîÏöîÏùº Ï∂îÍ∞Ä Ìï†Ïù∏</span>
        <span class="text-xs">-10%</span>
      </div>
    `
  }

  summaryDetails.innerHTML += `
    <div class="flex justify-between text-sm tracking-wide text-gray-400">
      <span>Shipping</span>
      <span>Free</span>
    </div>
  `
}

function updateTotal(amount) {
  const totalDiv = document.querySelector('#cart-total .text-2xl')
  if (totalDiv) {
    totalDiv.textContent = formatPrice(amount)
  }
}

function updateDiscountInfo(discountRate, originalTotal, totalAmount) {
  const discountInfo = document.getElementById('discount-info')
  discountInfo.innerHTML = ''

  if (discountRate > 0 && totalAmount > 0) {
    const savedAmount = originalTotal - totalAmount
    discountInfo.innerHTML = `
      <div class="bg-green-500/20 rounded-lg p-3">
        <div class="flex justify-between items-center mb-1">
          <span class="text-xs uppercase tracking-wide text-green-400">Ï¥ù Ìï†Ïù∏Ïú®</span>
          <span class="text-sm font-medium text-green-400">${formatDiscountRate(discountRate)}</span>
        </div>
        <div class="text-2xs text-gray-300">${formatPrice(savedAmount)} Ìï†Ïù∏ÎêòÏóàÏäµÎãàÎã§</div>
      </div>
    `
  }
}

function updateCartPrices() {
  const cartElements = cartDisp.children

  for (let i = 0; i < cartElements.length; i++) {
    const itemElement = cartElements[i]
    const productId = itemElement.id
    const product = getProduct(productId)

    if (product) {
      const priceDiv = itemElement.querySelector('.text-lg')
      const nameDiv = itemElement.querySelector('h3')

      priceDiv.innerHTML = formatProductPrice(product)
      nameDiv.textContent = formatProductName(product)
    }
  }

  updateCart()
}

function doRenderBonusPoints() {
  const cartItems = getCartItems()

  if (Object.keys(cartItems).length === 0) {
    document.getElementById('loyalty-points').style.display = 'none'
    return
  }

  const totalAmount = getTotalAmount()
  const totalQuantity = getTotalQuantity()

  let basePoints = Math.floor(totalAmount / 1000)
  let finalPoints = basePoints
  let pointsDetail = []

  if (basePoints > 0) {
    pointsDetail.push(`Í∏∞Î≥∏: ${basePoints}p`)
  }

  const isTuesday = new Date().getDay() === 2
  if (isTuesday && basePoints > 0) {
    finalPoints = basePoints * 2
    pointsDetail.push('ÌôîÏöîÏùº 2Î∞∞')
  }

  const hasKeyboard = cartItems[PRODUCT_IDS.KEYBOARD]
  const hasMouse = cartItems[PRODUCT_IDS.MOUSE]
  const hasMonitorArm = cartItems[PRODUCT_IDS.MONITOR_ARM]

  if (hasKeyboard && hasMouse) {
    finalPoints += POINTS.BONUS.SET
    pointsDetail.push('ÌÇ§Î≥¥Îìú+ÎßàÏö∞Ïä§ ÏÑ∏Ìä∏ +50p')
  }

  if (hasKeyboard && hasMouse && hasMonitorArm) {
    finalPoints += POINTS.BONUS.FULL_SET
    pointsDetail.push('ÌíÄÏÑ∏Ìä∏ Íµ¨Îß§ +100p')
  }

  if (totalQuantity >= 30) {
    finalPoints += POINTS.BONUS.BULK_30
    pointsDetail.push('ÎåÄÎüâÍµ¨Îß§(30Í∞ú+) +100p')
  } else if (totalQuantity >= 20) {
    finalPoints += POINTS.BONUS.BULK_20
    pointsDetail.push('ÎåÄÎüâÍµ¨Îß§(20Í∞ú+) +50p')
  } else if (totalQuantity >= 10) {
    finalPoints += POINTS.BONUS.BULK_10
    pointsDetail.push('ÎåÄÎüâÍµ¨Îß§(10Í∞ú+) +20p')
  }

  setBonusPoints(finalPoints)

  const loyaltyPointsDiv = document.getElementById('loyalty-points')
  if (finalPoints > 0) {
    loyaltyPointsDiv.innerHTML =
      `<div>Ï†ÅÎ¶Ω Ìè¨Ïù∏Ìä∏: <span class="font-bold">${finalPoints}p</span></div>` +
      `<div class="text-2xs opacity-70 mt-1">${pointsDetail.join(', ')}</div>`
    loyaltyPointsDiv.style.display = 'block'
  } else {
    loyaltyPointsDiv.textContent = 'Ï†ÅÎ¶Ω Ìè¨Ïù∏Ìä∏: 0p'
    loyaltyPointsDiv.style.display = 'block'
  }
}

main()
